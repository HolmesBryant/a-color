/**
 * @author Holmes Bryant <Holmes Bryant <https://github.com/HolmesBryant>
 * @version 2.0.0
 * @license GPL-3.0
 */
const e=new WeakMap;class ModelObserver{#e=new Map;subscribe(e,t){this.#e.has(e)||this.#e.set(e,new Set),this.#e.get(e).add(t)}unsubscribe(e,t){if(this.#e.has(e)){const s=this.#e.get(e);s.delete(t),0===s.size&&this.#e.delete(e)}}publish(e,t){this.#e.has(e)&&this.#e.get(e).forEach((e=>e(t)))}}const t=new class{#t=new Map;#s=!1;scheduleUpdate(e,t){this.#t.set(e,t),this.#s||(this.#s=!0,requestAnimationFrame((()=>this.#o())))}#o(){this.#t.forEach(((e,t)=>{t.isConnected&&t.applyUpdate(e)})),this.#t.clear(),this.#s=!1}};class ABind extends HTMLElement{#i=!1;#l="value";#n="input";#r=null;#d=null;#u=null;#h=!1;#c=null;#a=!1;#p=!1;#g=0;#b;#m;#f=!1;#y=!1;#E=!1;#v=null;#C=null;#A=null;#O=null;#w=null;#k=0;#U=null;static observedAttributes=["debug","elem-attr","event","func","model","model-attr","once","property","pull","push","throttle"];constructor(){super()}attributeChangedCallback(e,t,s){if(this.#i&&console.groupCollapsed(`attributeChangedCallback(${e}, ${t}, ${s})`),t!==s){switch(e){case"model":this.#d=s;break;case"property":this.#c=s;break;case"model-attr":this.#u=s;break;case"event":this.#n=s;break;case"elem-attr":this.#l=s;break;case"func":this.#r=s;break;case"throttle":this.#g=parseInt(s)||0;break;case"pull":this.#a=null!==s&&"false"!==s;break;case"push":this.#p=null!==s&&"false"!==s;break;case"once":this.#h=null!==s&&"false"!==s;break;case"debug":this.#i=null!==s&&"false"!==s}this.#i&&(console.log("isConnected",this.#y),console.groupEnd()),this.#y&&["model","property","model-attr"].includes(e)&&this.#T()}}connectedCallback(){this.#i&&console.log("connectedCallback()",this),window.abind||(window.abind=ABind),this.#y=!0,this.firstElementChild?this.#M():(this.#A=new MutationObserver((()=>{this.firstElementChild&&(this.#A.disconnect(),this.#A=null,this.#M())})),this.#A.observe(this,{childList:!0})),this.#i&&console.log("isConnected",this.#y)}disconnectedCallback(){this.#i&&console.log("disconnectedCallback",this),this.#z(),this.#A&&(this.#A.disconnect(),this.#A=null),this.#y=!1}static update(e,t,s){const o=ABind.#D(e,!0);o?o.publish(t,s):console.warn("a-bind: Invalid model for update",e)}static updateDefer(e,t,s=0){setTimeout((()=>{const s=this.#j(e,t);ABind.update(e,t,s)}),s)}applyUpdate(e){this.#i&&console.groupCollapsed(`applyUpdate(${e})`),this.#I(e),this.#i&&console.groupEnd()}#P(e){this.#i&&console.groupCollapsed(`#executeFunction(${e})`);const t=this.#r.split("."),s=t.pop(),o=t.join(".");let i=o?this.#j(this.#d,o):this.#d;i&&"function"==typeof i[s]||(i=o?this.#j(window,o):window),i&&"function"==typeof i[s]?(this.#i&&console.log("#executeFunction",{fnName:s,context:i,event:e}),i[s].call(i,e)):this.#i&&console.warn(`Function ${this.#r} not found.`),this.#i&&(console.log("fnName",s),console.log("ctx",i),console.log(this.#B()),console.groupEnd())}#j(e,t){this.#i&&console.groupCollapsed(`#getObjectProperty(${e}, ${t})`);const s=t?t.split(".").reduce(((e,t)=>e&&e[t]),e):e;return this.#i&&(console.log("value",s),console.log(this.#B()),console.groupEnd()),s}#$(e){if(this.#i&&(console.groupCollapsed(`#handleElementEvent(${e})`),console.log(this.#B())),this.#r&&this.#P(e),this.#a||!this.#c&&!this.#u)return void(this.#i&&console.groupEnd());let t;const s=this.#m;t="select"===s.localName&&s.multiple?Array.from(s.selectedOptions).map((e=>e.value)):"checkbox"===s.type?!!s.checked&&(s.getAttribute("value")||!0):void 0!==e.target.value?e.target.value:s[this.#l],this.#i&&(console.log("value",t),console.groupEnd()),this.#g>0?(this.#O&&clearTimeout(this.#O),this.#O=setTimeout((()=>{this.#R(t),this.#O=null}),this.#g)):this.#R(t)}async#M(){if(this.#i&&(console.groupCollapsed("#initialize()"),console.log("isInitializing",this.#E)),this.#E)this.#i&&console.groupEnd();else{this.#E=!0;try{if(!this.#d)return this.#E=!1,void(this.#i&&(console.log("#initialize paused: No model present yet."),console.groupEnd()));if(await this.#N(),!this.firstElementChild)return this.#E=!1,void(this.#i&&(console.log("firstElementChild",this.firstElementChild),console.log("isInitializing",this.#E),console.groupEnd()));let e=this.firstElementChild;for(;e&&"a-bind"===e.localName;)e=e.firstElementChild;if(this.#m=e,!this.#m)return console.error("a-bind: No valid child element to bind to."),this.#E=!1,void(this.#i&&(console.log("boundElement",this.#m),console.log("isInitializing",this.#E),console.groupEnd()));this.#i&&(console.log("Initialized:",{boundElement:this.#m}),console.log(this.#B()),console.groupEnd()),this.#b=new AbortController,this.#x(),this.#I()}catch(e){console.error("a-bind initialization error:",e,this)}finally{this.#E=!1}}}#B(){let e={};const t=ABind.observedAttributes;for(const s of t)switch(s){case"model":e.model=this.#d;break;case"property":e.property=this.#c;break;case"model-attr":e.modelAttr=this.#u;break;case"event":e.event=this.#n;break;case"elem-attr":e.elemAttr=this.#l;break;case"func":e.func=this.#r;break;case"throttle":e.throttle=this.#g;break;case"pull":e.pull=this.#a;break;case"push":e.push=this.#p;break;case"once":e.once=this.#h}return e}#T(){this.#i&&console.groupCollapsed("#reinitialize()"),this.#z(),this.#M(),this.#i&&console.groupEnd()}async#N(){if(this.#i&&console.groupCollapsed("#resolveModel()"),"object"==typeof this.#d)return this.#d.localName&&this.#d.localName.includes("-")?(await customElements.whenDefined(this.#d.localName),void(this.#i&&(console.log("resolved: model is custom element"),console.log(this.#B()),console.groupEnd()))):void(this.#i&&(console.log("resolved: model is object"),console.log(this.#B()),console.groupEnd()));const e=this.#d;if("string"==typeof e){const t=document.querySelector(e);if(t)return t.localName.includes("-")&&(await customElements.whenDefined(t.localName),this.#i&&console.log("custom element")),this.#d=t,void(this.#i&&(console.log("resolved via DOM Selector:"),console.log(this.#B()),console.groupEnd()));const s=this.#j(window,e);if(s)return this.#d=s,void(this.#i&&(console.log("resolved via Window Scope"),console.log(this.#B()),console.groupEnd()))}this.#i&&(console.warn("Model not resolved"),console.log(this.#B()),console.groupEnd())}#L(e,t,s){if(null==s&&(s=""),this.#i&&console.groupCollapsed(`#setElementAttribute(${e}, ${t}, ${s})`),t.startsWith("style."))return e.style[t.split(".")[1]]=s,void(this.#i&&(t.split(".")[1],console.log({cssProp:s}),console.groupEnd()));if("input"!==e.localName||"checkbox"!==e.type&&"radio"!==e.type)if("select"===e.localName&&e.multiple){const t=Array.isArray(s)?s.map(String):String(s).split(",");Array.from(e.options).forEach((e=>e.selected=t.includes(e.value))),this.#i&&console.log("selectedOptions",e.selectedOptions)}else t in e?e[t]=s:e.setAttribute(t,s);else e.checked=String(e.value)===String(s),this.#i&&console.log({checked:e.checked});this.#i&&(console.log(this.#B()),console.groupEnd())}#V(e,t,s){this.#i&&console.groupCollapsed(`#setObjectProperty(${e}, ${t}, ${s})`);const o=t.split("."),i=o.pop(),l=o.length?this.#j(e,o.join(".")):e;l&&"object"==typeof l&&(l[i]=s),this.#i&&(console.log("target",l),console.log("last",i),console.log("target[last]",l[i]),console.log(this.#B()),console.groupEnd())}#x(){if(!this.#c&&!this.#r&&!this.#u)return;if(this.#i&&console.groupCollapsed("#setupListeners()"),this.#n&&!this.#a&&(this.#i&&(console.log("Element -> Model"),console.log("boundElement",this.#m)),this.#m.addEventListener(this.#n,(e=>this.#$(e)),{signal:this.#b.signal})),this.#p)return void(this.#i&&(console.log(this.#B()),console.groupEnd()));const e=ABind.#D(this.#d,!0);this.#C=this.#c||this.#u,this.#i&&console.log("#setupListeners: Model -> Element",{property:this.#c,modelAttr:this.#u}),e&&this.#C?(this.#v=e=>{if(this.#h&&this.#f)this.#i&&(console.log("subscribedProperty",this.#C),console.log("hasUpdated",this.#f),console.log(this.#B()),console.groupEnd());else if(this.#g>0){const s=Date.now(),o=s-this.#k;if(o>=this.#g)this.#k=s,t.scheduleUpdate(this,e),this.#i&&(console.log("scheduleUpdate",e),console.log(this.#B()),console.groupEnd());else if(this.#U=e,this.#i&&(console.log("Output throttled (Model -> UI)"),console.log("pendingOutputValue",this.#U),console.log("wait for",this.#g-o),console.log(this.#B()),console.groupEnd()),!this.#w){const e=this.#g-o;this.#w=setTimeout((()=>{this.#k=Date.now(),t.scheduleUpdate(this,this.#U),this.#w=null}),e)}}else t.scheduleUpdate(this,e)},e.subscribe(this.#C,this.#v)):this.#i&&(console.log(this.#B()),console.groupEnd())}#z(){this.#i&&console.groupCollapsed("#teardown()"),this.#b?.abort(),this.#O&&clearTimeout(this.#O),this.#w&&clearTimeout(this.#w),this.#O=null,this.#w=null,this.#U=null;const e=ABind.#D(this.#d,!1);e&&this.#C&&this.#v&&e.unsubscribe(this.#C,this.#v),this.#C=null,this.#v=null,this.#i&&(console.log("abortController",this.#b),console.log("inputTimer",this.#O),console.log("outputTimer",this.#w),console.log("pendingOutputValue",this.#U),console.log("subscribedProperty",this.#C),console.log("subscriptionCallback",this.#v),console.groupEnd())}#I(e){if(this.#i&&console.groupCollapsed(`#updateElement(${e})`),!this.#c&&!this.#u||this.#h&&this.#f||this.#p)return void(this.#i&&(console.log(this.#B()),console.groupEnd()));void 0===e&&(e=this.#u?this.#d.getAttribute(this.#u):this.#j(this.#d,this.#c));this.#l.split(",").map((e=>e.trim())).forEach((t=>{this.#L(this.#m,t,e),this.#i&&console.log(t,e)})),this.#f=!0,this.#i&&(console.log("hasUpdated",this.#f),console.log(this.#B()),console.groupEnd())}#R(e){let t;if(this.#i&&console.groupCollapsed(`#updateModel(${e})`),t=this.#u?this.#d.getAttribute(this.#u):this.#j(this.#d,this.#c),this.#i&&console.log({value:e,oldValue:t}),t==e)return void(this.#i&&(console.log("Update skipped: Values are loosely equal.",{oldValue:t,value:e}),console.groupEnd()));this.#u?this.#d.setAttribute(this.#u,e):this.#V(this.#d,this.#c,e);const s=ABind.#D(this.#d,!1),o=this.#c||this.#u;s&&o&&s.publish(o,e),this.#i&&(console.log("observer.publish()",o,e),console.log(this.#B()),console.groupEnd())}static#D(t,s){return t&&"object"==typeof t?(!e.has(t)&&s&&e.set(t,new ModelObserver),e.get(t)||null):null}get model(){return this.#d}set model(e){this.#d=e,this.#y&&this.#T()}}class ABindgroup extends HTMLElement{static modelRegistry=new Map;static modelReferenceCounts=new Map;#q=null;#S=null;#F=null;async connectedCallback(){try{const e=this.getAttribute("model");if(!e)throw new Error('a-bindgroup requires "model" attribute.');const t=document.body.querySelector(e);if(t)this.#q=e,this.#S=t;else{const{modelInstance:t,modelUrl:s}=await this.#W(e);this.#q=s,this.#S=t}const s=ABindgroup.modelReferenceCounts.get(this.#q)||0;ABindgroup.modelReferenceCounts.set(this.#q,s+1),this.#H(),this.#F=new MutationObserver((e=>{let t=!1;for(const s of e)s.addedNodes.length>0&&(t=!0);t&&this.#H()})),this.#F.observe(this,{childList:!0,subtree:!0})}catch(e){console.error(e,this)}}disconnectedCallback(){if(this.#F?.disconnect(),this.#q){const e=ABindgroup.modelReferenceCounts.get(this.#q);1===e?(ABindgroup.modelRegistry.delete(this.#q),ABindgroup.modelReferenceCounts.delete(this.#q)):ABindgroup.modelReferenceCounts.set(this.#q,e-1)}}#H(){if(!this.#S)return;this.querySelectorAll("a-bind").forEach((e=>{e.model||(e.model=this.#S)}))}async#W(e){let t;return t=e.match(/\.(js|mjs)$/)||e.includes("/")?new URL(e,import.meta.url).href:new URL(`${e}.js`,import.meta.url).href,this.#G(t,e)}async#G(e,t){if(ABindgroup.modelRegistry.has(e))return{modelInstance:ABindgroup.modelRegistry.get(e),modelUrl:e};try{const t=await import(e);if("function"!=typeof t.default)throw new Error(`Module ${e} missing default class export.`);const s=new t.default;return ABindgroup.modelRegistry.set(e,s),{modelInstance:s,modelUrl:e}}catch(s){if(e.endsWith(".js")&&!t.endsWith(".js")){const s=e.replace(".js",".mjs");return this.#G(s,t)}throw s}}}customElements.get("a-bind")||customElements.define("a-bind",ABind),customElements.get("a-bindgroup")||customElements.define("a-bindgroup",ABindgroup);export{ABindgroup,ABind as default};
