/**
 * @author Holmes Bryant <https://github.com/HolmesBryant>
 * @license GPL-3.0
 * @version 2.0.2
 */
class ACode extends HTMLElement{#t=!1;#e=!1;#i=!1;#n=2;#s=!1;#h=null;#l="pre";#r;#o;#a=null;#d;#g;#c;highlighter;static observedAttributes=["highlight","inline","indent","line-numbers","palette","wrap"];static template=document.createElement("template");static{this.template.innerHTML='\n    <style>\n      :host {\n        --line-number-color: gray;\n        --wrap: pre;\n        display: block;\n        max-width: 100%;\n        vertical-align: top;\n      }\n\n      :host([inline]) {\n        display: inline-block;\n        vertical-align: middle;\n      }\n\n      section {\n        display: inline-grid;\n        gap: .5rem;\n        grid-template-columns: max-content 1fr;\n        width: 100%;\n      }\n\n      :host([inline]) section {\n        display: block;\n      }\n\n      #content {\n        font-family: "Courier New", monospace;\n        tab-size: var(--indent);\n        white-space: var(--wrap);\n        overflow: auto;\n        outline: none;\n        text-align: left;\n      }\n\n      #line-numbers {\n        color: var(--line-number-color);\n        font-family: "Courier New", monospace;\n        white-space: pre;\n        text-align: right;\n        user-select: none;\n      }\n    </style>\n\n    <section part="section">\n      <pre id="line-numbers" part="line-numbers"></pre>\n      <pre id="content" part="content"><slot></slot></pre>\n    </section>\n  '}constructor(){super(),this.attachShadow({mode:"open"})}attributeChangedCallback(t,e,i){if(e!==i)switch(t){case"highlight":i="false"!==i&&(null===i||""===i?"html":i),this.#e=i,this.#u(i);break;case"inline":i="false"!==i&&null!==i,this.#i=i,this.#p(i);break;case"indent":i=parseFloat(i),this.#n=i,this.style.setProperty("--indent",i),this.#m("indent",i);break;case"line-numbers":i="false"!==i&&null!==i,this.#s=i,this.#f(i);break;case"palette":this.#h=i,this.highlighter&&this.highlighter.setPalette(i),this.#m("palette",i);break;case"wrap":this.#l=i,this.style.setProperty("--wrap",i),this.#m("wrap",i)}}connectedCallback(){this.shadowRoot.hasChildNodes()||this.shadowRoot.append(ACode.template.content.cloneNode(!0)),this.#o=this.shadowRoot.querySelector("#content"),this.#d=this.shadowRoot.querySelector("#line-numbers"),this.#r=new AbortController,this.#g=new MutationObserver(this.#y.bind(this));const t=this.#b(this.#w());this.#a=t,this.#o.textContent=t,this.indent=this.#n,this.#f(this.#s),this.#e&&this.#u(),this.#g.observe(this,{childList:!0,subtree:!0,characterData:!0})}disconnectedCallback(){this.#r&&(this.#r.abort(),this.#r=null),this.#g&&(this.#g.disconnect(),this.#g=null),this.#N(),this.highlighter=null,this.#h=null,this.#o=null,this.#d=null}#C(t){const e=document.createElement("textarea");return e.innerHTML=t,e.value}#N(){if(this.highlighter)try{this.highlighter.destroy()}catch(t){console.error(t)}}#w(){const t=this.firstElementChild;if(t&&"textarea"===t.localName){return t.value.replace(/\\\//g,"/")}return this.#C(this.innerHTML)}#u(t=this.#e,e=this.palette){if(this.#o&&(this.highlighter&&this.highlighter.destroy(),"false"!==t&&!1!==t)){this.highlighter=new Highlighter(this,t,e);try{const t=Array.from(this.#o.childNodes).find((t=>t.nodeType===Node.TEXT_NODE));t&&this.highlighter.highlight(t),this.#m("highlight",this.#e)}catch(t){console.error("Highlighting failed",t)}}}#m(t,e){const i=customElements.get("a-bind");i&&i.update(this,t,e)}#b(t){if(!t)return"";if(!(t=(t=t.replace(/\r\n/g,"\n")).replace(/^\n+/,"").trimEnd()))return"";const e=(t=t.replace(/\t/g," ")).split("\n"),i=e[0].match(/^[ ]*/),n=i?i[0].length:0;return e.map((t=>t.replace(new RegExp(`^[ ]{0,${n}}`),"").replace(/^[ ]+/g,(t=>"\t".repeat(t.length))))).join("\n")}#p(t){this.#i=t,!0===t?(this.style.setProperty("--wrap","nowrap"),this.lineNumbers=!1):this.style.setProperty("--wrap",this.#l),this.#m("inline",this.#i)}#f(t){if(this.#d){if(!0===t){const t=this.#o.textContent.split(/\n/).length,e=Array.from({length:t},((t,e)=>e+1)).join("\n");this.#d.textContent=e,this.inline=!1}else this.#d.innerHTML="";this.#m("lineNumbers",t)}}#y(t=10){clearTimeout(this.#c),this.#c=setTimeout((()=>{const t=this.#w(),e=this.#b(t);e!==this.#a&&(this.#a=e,this.#o.textContent=e,this.highlighter&&this.#N(),this.lineNumbers&&this.#f(this.#s),this.#e&&requestAnimationFrame((()=>this.#u())))}),t)}get inline(){return this.#i}set inline(t){this.toggleAttribute("inline","false"!==t&&!1!==t)}get indent(){return this.#n}set indent(t){this.setAttribute("indent",t)}get highlight(){return this.#e}set highlight(t){this.setAttribute("highlight",t)}get lineNumbers(){return this.#s}set lineNumbers(t){this.toggleAttribute("line-numbers","false"!==t&&!1!==t)}get palette(){return this.#h}set palette(t){"object"==typeof t&&(t=JSON.stringify(t)),this.setAttribute("palette",t)}get value(){return this.#w()}set value(t){const e=null==t?"":String(t);if(this.#w()===e)return;const i=this.firstElementChild;i&&"textarea"===i.localName?i.value=e:this.textContent=e,this.#y(0),this.#m("value",e)}get wrap(){return this.#l}set wrap(t){this.setAttribute("wrap",t)}}const t=new Map;class Highlighter{#S=null;#x={};#E;#h;#T;#v;#H;#R=0;#A={argument:/(?<=\()[^)]+(?=\))/g,operator:/[>~+*|=^$]/g,property:/(?<!@)\b[\w-]+(?=:)/g,number:/[+-]?\b\d*\.?\d+(?:e[+-]?\d+)?(?:%|[a-z]{1,4})?\b/gi,tag:/<\/?[\w-]+|\/>|(?<=[\w"'])>/g,string:/(["'])(?:\\.|[^\\])*?\1/g,comment:/(<!--|\/\*)([\s\S]*?)(-->|\*\/)/g,keyword:/@[\w]+\b/g,variable:/--[\w\d]+-?[\w\d]*/g,function:/[\w-]+\s*(?=\()/g};#k=new Map([["argument","hsl(32, 93%, 66%)"],["comment","hsl(221, 12%, 69%)"],["function","hsl(210, 50%, 60%)"],["keyword","deeppink"],["number","hsl(32, 93%, 50%)"],["operator","red"],["property","orchid"],["string","hsl(114, 31%, 68%)"],["variable","darkkhaki"],["tag","indianred"]]);constructor(t,e,i,n){if(!(t instanceof HTMLElement))throw new Error("Element passed to Highlighter must be an HTML element");this.#v=t,this.#S=e,this.setPalette(i),this.#E=n||Math.random().toString(36).substring(2,9),this.#T=this.#$();const s=t.shadowRoot||t.attachShadow({mode:"open"});s.adoptedStyleSheets=[...s.adoptedStyleSheets,this.#T]}destroy(){this.#M(),this.#v&&this.#v.shadowRoot&&(this.#v.shadowRoot.adoptedStyleSheets=this.#v.shadowRoot.adoptedStyleSheets.filter((t=>t!==this.#T))),this.#v=null,this.#H=null}async highlight(t){if(t&&t.nodeType!==Node.TEXT_NODE&&(t.childNodes.length>0&&(t=Array.from(t.childNodes).find((t=>t.nodeType===Node.TEXT_NODE))),t||(t=document.createTextNode(""))),!(this.#H=t||this.#H))return;const e=++this.#R,i=await this.#L(this.#S);if(e===this.#R){this.#x=i;try{this.#P(this.#x,this.#H)}catch(t){console.error("Error highlighting code:",t)}}}setPalette(t){let e;if(t instanceof Map)e=t;else if("string"==typeof t)if("default"===t)e=this.#k;else try{e=new Map(JSON.parse(t))}catch(t){console.warn("Invalid palette JSON string, using default.",this.#v),e=this.#k}else e=this.#k;if(this.#h=e,this.#T){const t=this.#$();this.#T.replaceSync(t.cssRules[0]?.cssText?Array.from(t.cssRules).map((t=>t.cssText)).join(" "):"")}}#D(t,e){if(!t||0===t.size)return;const i=`${e}-${this.#E}`,n=new Highlight(...t);CSS.highlights.set(i,n)}#$(){const t=new CSSStyleSheet;let e="";return this.#h.forEach(((t,i)=>{const n=`${i}-${this.#E}`;e+=`::highlight(${n}) { color: ${t}; } `})),t.replaceSync(e),t}#M(){if(this.#x)for(const t of Object.keys(this.#x)){const e=`${t}-${this.#E}`;CSS.highlights.delete(e)}}#P(t,e){if(e.nodeType!==Node.TEXT_NODE)return 0;const i=e.textContent;for(const[n,s]of Object.entries(t)){let t;if(s){if(Array.isArray(s)){const n=[...new Set(s)].map((t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"))).join("|"),h=new RegExp(`\\b(${n})\\b`,"g");t=this.#O(h,i,e)}else if("function"==typeof s)t=new Set(s(i,e));else{if(!(s instanceof RegExp)){console.warn(`Invalid syntax definition for ${n}`);continue}t=this.#O(s,i,e)}this.#D(t,n)}}return CSS.highlights.size}async#L(e){if(!e||"html"===e)return this.#A;if("object"==typeof e)return t.set("custom",e),e;if(t.has(e))return t.get(e);let i=e;/^(http|\.|\/)/.test(e)||(i=`./syntax.${e}.js`);try{const n=(await import(i)).default;return t.set(e,n),n}catch(t){return console.warn(`Could not load syntax file: ${i}. Reverting to default.`,t),this.#A}}#O(t,e,i){const n=new Set,s=e.matchAll(t);for(const t of s)if(0!==t[0].length)try{const e=new Range;e.setStart(i,t.index),e.setEnd(i,t.index+t[0].length),n.add(e)}catch(t){}return n}}customElements.get("a-code")||customElements.define("a-code",ACode);export{Highlighter,ACode as default};
